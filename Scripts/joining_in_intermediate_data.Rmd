
# Set up

Import packages
```{r}
suppressPackageStartupMessages({
  suppressWarnings({
  library(tidyverse)   # Data wrangling
  library(here)        # File management
  library(readxl)      # Read excel files
  })})
```

Set settings and universal variables
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here())
```

# Import data

Cleaned & deduplicated network data
```{r}
network = read.csv("data/Outputs/20251002_network_data_cleaned.csv")
```

Missing source lat/longs key
```{r}
master_key = read.csv("Data/Outputs/20251002_missing_source_lat_long_key.csv")
```

Source IDs
```{r}
source_ids = read.csv("Data/Outputs/20251002_source_id_key.csv")
```

Project columns
```{r}
project_cols = read.csv("Data/Outputs/20251002_project_columns.csv")
```

GW variables
```{r}
network_pwsids_w_gw_variables = read.csv("Data/Outputs/20251002_network_pwsids_w_gw_variables.csv")

network_pwsids_w_gw_variables_excl_consecutive_connections = read.csv("Data/Outputs/20251002_network_pwsids_w_gw_variables_excl_consecutive_connections.csv")%>%
  rename(gw_access_no_cc = 2, gw_compliant_w_dw_standards_no_cc = 3)
```


# Joins

Join lat/longs from matched clearinghouse facilities back to network data.
Replace Source_lat & Source_lon columns with lat/longs from clearinghouse for rows in which we were able to find the lat/long in the SAFER clearinghouse data
```{r}
network_joined = network%>%
  left_join(., master_key, by = c("Source", "PWSID"))%>%
  mutate(Source_lat = ifelse(is.na(Source_lat), clearinghouse_lat, Source_lat),
         Source_lon = ifelse(is.na(Source_lon), clearinghouse_long, Source_lon))%>%
  select(-c(matched_facility_name:clearinghouse_long))
```

Join in new project columns
```{r}
network_joined = network_joined%>%
  left_join(., project_cols, by = c("PWSID", "Source"))
```

Join source IDs
```{r}
network_joined = network_joined%>%
  left_join(., source_ids, by = "Source")
```

Join gw variables
```{r}
network_joined = network_joined%>%
  left_join(., network_pwsids_w_gw_variables, by = c("PWSID" = "pwsid"))%>%
  left_join(., network_pwsids_w_gw_variables_excl_consecutive_connections, by = c("PWSID" = "pwsid"))
```

# Export
```{r}
network_final = network_joined%>%
  select(1:Source_number, gw_access:gw_compliant_w_dw_standards_no_cc, source_id, Source, Source_summary, Source_type:Source_lon, Combined_source_notes, Project, swp:colorado, Purchased, X2020_CCR_percent:Average_source_method, Summer_2025_cleaning:CalSim_notes_Sept2025)

write.csv(network_final, "Data/Outputs/20251002_network_data_cleaned_joined.csv", row.names = T)
```


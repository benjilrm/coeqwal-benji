

# Set up

Import packages
```{r}
suppressPackageStartupMessages({
  suppressWarnings({
  library(tidyverse)   # Data wrangling
  library(here)        # File management
  library(igraph)      # Network analysis
  library(GGally)      # Exploratory scatter plots
  })})
```

Set settings and universal variables
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here())
```

# Import data

## Network data
Our cleaned and processed network data generated into an igraph object
```{r}
load("data for upload/20251124_network_igraph.Rdata")
``` 

## Drought vulnerability

DWR small system vulnerability data for validation, hosted on [this page](https://water.ca.gov/Programs/Water-Use-And-Efficiency/SB-552/SB-552-Tool) and downloaded as a csv from [this link](https://data.cnra.ca.gov/dataset/i07-water-shortage-vulnerability-small-water-systems).

More information on documentation and methodology is available [here](https://data.cnra.ca.gov/dataset/water-shortage-vulnerability-technical-methods/resource/090baaf3-dc47-4e21-8eba-d9bf499a76a0)
```{r}
dwr_vulnerability = read.csv("Data/Source/Small System Drought Vulnerability/i07_Water_Shortage_Vulnerability_Small_Water_Systems.csv")%>%
  select(SABL_PWSID, SC5e_Drought_Impact)%>%
  rename(pwsid = 1, drought_vulnerable = 2)%>%
  mutate(drought_vulnerable = ifelse(grepl("Listed as having", drought_vulnerable), 1, 0))
```

To get more commprehensive drought vulnerability data, we also add to this list a dataset of drought-vulnerable public water systems compiled by the Pacific Institute as part of [this](https://pacinst.org/wp-content/uploads/2017/01/PI_DroughtAndEquityInCA_Jan_2017.pdf) 2017 report. The data sources are also listed [here](https://pacinst.org/wp-content/uploads/2017/01/PI_DroughtAndEquityInCA-2017_Appendix1A_3.pdf). 
```{r}
pacific_vulnerability = read.csv("Data/Source/Small System Drought Vulnerability/Appendix-1B-Drought-Impacted-Public-Water-Systems.xlsx - DroughtImpactedPWS.csv")%>%
  rename(pwsid = PWSID)%>%
  select(pwsid)%>%
  filter(pwsid != "")%>%
  mutate(drought_vulnerable = 1)
```

Now we can combine the two. We'll consider a system drought vulnerable if it appears in any of the vulnerability datasets. 
```{r}
comb_vulnerability = rbind(dwr_vulnerability, pacific_vulnerability)%>%
  group_by(pwsid)%>%
  reframe(drought_vulnerable = max(drought_vulnerable))%>%
  ungroup()
```



# Analysis / Calculating Metrics

## Centrality

Calculate in, out, and total degree centrality for systems. Compile into one 'master' dataframe with system centralities 
```{r}
system_centrality = all_nodes%>%
  filter(type == "system")%>%
  rename(in_degree = num_sw_sources,
         out_degree = num_systems_served,
         pwsid = id)%>%
  mutate(
    out_degree = replace_na(out_degree, 0),
    total_degree = in_degree + out_degree)%>%
  arrange(-total_degree)%>%
  select(pwsid, in_degree, out_degree, total_degree)
```

Calculate betweenness centrality - systems that are major redistribution hubs (ie: measure of centrality based on shortest paths that pass through a given node). Add to master dataframe.
```{r}
betweenness_all = betweenness(network, directed = TRUE)
system_centrality$betweenness = betweenness_all[V(network)$type == "system"]

rm(betweenness_all)
```

Out degree centrality for sources
```{r}
source_centrality = all_nodes%>%
  rename(source_name = id, out_degree = num_systems_served)%>%
  filter(type == "source")%>%
  arrange(-out_degree)%>%
  select(1:3)
```

## Path length

Calculate shortest paths from sources to systems
```{r}
sources = V(network)[type == "source"]
systems = V(network)[type == "system"]

# Get shortest paths between all sources to all systems
path_length_matrix = distances(network, v = sources, to = systems, mode = "out")
#path_lengths = as.vector(path_length_matrix[is.finite(as.vector(path_length_matrix))])


# Get shortest paths between all systems (for reachable systems calculation)
system_to_system_matrix = distances(network, v = systems, to = systems, mode = "out")
```

Summary stats for sources' path lengths
```{r}
data.frame(
  source_name = sources$name,
  source_type = V(network)[sources]$source_type,
  mean_path_length = apply(path_length_matrix, 1, function(x) mean(x[is.finite(x)])),
  median_path_length = apply(path_length_matrix, 1, function(x) median(x[is.finite(x)])),
  max_path_length = apply(path_length_matrix, 1, function(x) max(x[is.finite(x)])),
  min_path_length = apply(path_length_matrix, 1, function(x) min(x[is.finite(x)])),
  n_reachable_systems = apply(path_length_matrix, 1, function(x) sum(is.finite(x))))%>%
  arrange(-mean_path_length)
```

Summary stats for systems' path lengths

Right now, this is ONLY when systems are the final node on a path
```{r}
system_path_lengths = data.frame(
  pwsid = systems$name,
  mean_path_length = apply(path_length_matrix, 2, function(x) mean(x[is.finite(x)])),
  median_path_length = apply(path_length_matrix, 2, function(x) median(x[is.finite(x)])),
  max_path_length = apply(path_length_matrix, 2, function(x) max(x[is.finite(x)])),
  min_path_length = apply(path_length_matrix, 2, function(x) min(x[is.finite(x)])),
  n_reachable_sources = apply(path_length_matrix, 2, function(x) sum(is.finite(x))),
  n_reachable_systems = apply(system_to_system_matrix, 1, function(x) sum(is.finite(x)) - 1)) %>%  # Subtract 1 to exclude self
  arrange(-max_path_length)

rm(path_length_matrix)
```

## Source diversity

```{r}
# Calculate HHI for each system
system_diversity = sapply(systems, function(system) {
  # Get edges going into this system (sources supplying it)
  incoming_edges = E(network)[.to(system)]
  
  if (length(incoming_edges) == 0) return(NA)  # no sources
  
  # Get the usage percentages for this system's sources
  usage_percentages = incoming_edges$average_source_usage/100
  
  # Calculate HHI (sum of squares of market shares, scaled 0-10000)
  hhi = sum((usage_percentages * 100)^2)
  
  return(hhi)})

# Create a diversity data frame
diversity_df = data.frame(
  pwsid = systems$name,
  hhi = system_diversity,
  stringsAsFactors = FALSE,
  row.names = NULL)

rm(system_diversity, systems, sources)
```

Kristin also mentioned [participation coefficient](https://www.google.com/url?q=https://www.nature.com/articles/s41467-017-01189-w%23:~:text%3DParticipation%2520coefficient,-Given%2520a%2520particular%26text%3Dwhere%2520%257BK_i%257D%2520is%2520the%2520sum,are%2520to%2520a%2520single%2520community&sa=D&source=docs&ust=1762796373372331&usg=AOvVaw3DkgsUakhBdOK-fW7kOtPS). 

Seems like there are options to calculate it in R [example](https://search.r-project.org/CRAN/refmans/NetworkToolbox/html/participation.html)


## Local density / cluster / community
Kristin's hypothesis: on average, small systems will have less local density than large systems
How can we test?

## Bipartite project

Create one-mode projection on systems (systems connected if they share sources)
```{r, eval = F}
V(network)$type <- V(network)$type == "system"
system_adjacency = bipartite_projection(network)$proj1



```

# Combine all metrics into one dataframe

Join all system network metrics with system covariates. This can be used as the 'master file' for analysis.
```{r}
system_metrics_comb = left_join(system_centrality, system_path_lengths, by = "pwsid")%>%
  left_join(., diversity_df, by = "pwsid")%>%
  left_join(., all_nodes%>%
              filter(type == "system")%>%
              select(id, system_name:num_sw_sources)%>%
              rename(pwsid = id), 
            by = "pwsid")%>%
  left_join(., comb_vulnerability, by = "pwsid")
  
#rm(diversity_df, system_centrality, system_path_lengths, dwr_vulnerability)

table(system_metrics_comb$drought_vulnerable, useNA = "always")
```
Seems like among the small systems, we have 61 NAs where we can't find that system's PWSID in the DWR vulnerability data. Bring up with Kristin. 


```{r}
system_metrics_comb%>%
  filter(hhi > 10000)

as_data_frame(network, what = "edges")%>%
  filter(to %in% c("CA1910200", "CA1910127", "CA5601117"))
```
Just flagging there are a few systems with more than the max HHI (10000) because their average source usages add up to over 100%



Code could potentially be split here so that we have one script that calculates network metrics and produces this master dataframe, which would be the input into a 2nd script focused on visualisations/analysis

# Visualisations / Tables

## Centrality

### Systems
System in-degree centrality
Possible metric for systems' source redunancy (# of sources)
```{r}
system_metrics_comb%>%
  group_by(system_size)%>%
  reframe(in_degree = mean(in_degree, na.rm = T))%>%
  #filter(!is.na(system_size))%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = in_degree, fill = system_size))+
  geom_bar(stat = "identity")+
  theme_bw()+
  labs(x = "System Size", y = "Mean In-Degree Centrality")+
  theme(legend.position = "none")

system_metrics_comb%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = in_degree, fill = system_size))+
  geom_violin()+
  theme_bw()+
  labs(x = "System Size", y = "In-Degree Centrality")+
  theme(legend.position = "none")
```

Out, total, betweenness centrality for systems
(more of a metric for measuring importance of redistribution hubs)
```{r}
ggplot(system_metrics_comb, aes(total_degree))+
  geom_histogram(fill = "coral2", colour = "black")+
  theme_bw()

system_metrics_comb%>%
  group_by(system_size)%>%
  reframe(total_degree = mean(total_degree, na.rm = T))%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = total_degree, fill = system_size))+
  geom_bar(stat = "identity")+
  theme_bw()+
  labs(x = "System Size", y = "Total Degree Centrality")+
  theme(legend.position = "none")+
  scale_y_log10()

system_metrics_comb%>%
  group_by(system_size)%>%
  reframe(betweenness = mean(betweenness, na.rm = T))%>%
  #filter(!is.na(system_size))%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = betweenness, fill = system_size))+
  geom_bar(stat = "identity")+
  theme_bw()+
  labs(x = "System Size", y = "Mean Betweenness Centrality")+
  theme(legend.position = "none")

system_metrics_comb%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = betweenness, fill = system_size))+
  geom_violin()+
  theme_bw()+
  labs(x = "System Size", y = "Betweenness Centrality")+
  theme(legend.position = "none")+
  scale_y_log10()
```

### Sources
```{r}
ggplot(source_centrality, aes(out_degree))+
  geom_histogram(fill = "coral2", colour = "black")+
  theme_bw()
```


## Source diversity
Systems' source diversity 
HHI index as possible metric for source diversity

```{r}
system_metrics_comb%>%
  group_by(system_size)%>%
  reframe(hhi = mean(hhi, na.rm = T))%>%
  #filter(!is.na(system_size))%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = hhi, fill = system_size))+
  geom_bar(stat = "identity")+
  theme_bw()+
  labs(x = "System Size", y = "Mean HHI")+
  theme(legend.position = "none")

system_metrics_comb%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = hhi, fill = system_size))+
  geom_violin()+
  theme_bw()+
  labs(x = "System Size", y = "HHI")+
  theme(legend.position = "none")
```

## Path length
Systems' path length to nearest source
Possible metric for source diversity
```{r}
system_metrics_comb%>%
  group_by(system_size)%>%
  reframe(mean_path_length = mean(mean_path_length, na.rm = T))%>%
  #filter(!is.na(system_size))%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = mean_path_length, fill = system_size))+
  geom_bar(stat = "identity")+
  theme_bw()+
  labs(x = "System Size", y = "Mean Path Length")+
  theme(legend.position = "none")

system_metrics_comb%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = mean_path_length, fill = system_size))+
  geom_violin()+
  theme_bw()+
  labs(x = "System Size", y = "Path Length")+
  theme(legend.position = "none")
```

# Summary stats

System network metrics
Filter for very small/small/medium systems
```{r}
system_metrics_comb%>%
  filter(pop_served <= 10000)%>%
  select(in_degree, out_degree, betweenness, mean_path_length, hhi, n_reachable_sources, n_reachable_systems)%>%
  #summary()%>%
  describe(quant = c(0.25, 0.75)) %>%
  as.data.frame()%>%
  rownames_to_column("variable")%>%
  select(-c(vars, sd, trimmed, mad, range:se))
  select(variable, mean, sd, min, max, range, Q0.25, median, Q0.75, IQR = Q0.75 - Q0.25)

library(psych)

summary_table <- system_metrics_comb %>%
  filter(pop_served <= 10000) %>%
  select(in_degree, out_degree, betweenness, mean_path_length, hhi, n_reachable_sources, n_reachable_systems) %>%
  describe(quant = c(0.25, 0.75)) %>%
  as.data.frame() %>%
  rownames_to_column("variable") %>%
  select(variable, mean, sd, min, max, range, Q0.25, median, Q0.75, IQR = Q0.75 - Q0.25)

# View the table
print(summary_table)
```

Plots
```{r}
system_metrics_comb%>%filter(pop_served <= 10000)%>%
  select(in_degree:total_degree, betweenness)%>%
  pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
  ggplot(aes(value))+
  geom_histogram(binwidth = 1, fill = "steelblue", color = "black", alpha = 0.7) +
  facet_wrap(~variable, scales = "free")+
  labs(title = "System Centrality Metrics", x = "Value", y = "# of Systems") +
  theme_bw()

system_metrics_comb%>%filter(pop_served <= 10000)%>%
  select(mean_path_length:n_reachable_sources)%>%
  pivot_longer(everything(), names_to = "variable", values_to = "value")%>%
  ggplot(aes(value))+
  geom_histogram(binwidth = 1, fill = "steelblue", color = "black", alpha = 0.7) +
  facet_wrap(~variable, scales = "free")+
  labs(title = "System Path Lengths Metrics", x = "Value", y = "# of Systems") +
  theme_bw()

system_metrics_comb%>%filter(pop_served <= 10000)%>%
  ggplot(aes(hhi))+
  geom_histogram(fill = "steelblue", color = "black", alpha = 0.7) +
  labs(title = "System Source Diversity Metric", x = "Herfindahlâ€“Hirschman Index", y = "# of Systems") +
  theme_bw()
```

# Relationship between metrics

Let's make some quick scatter plots just to see the relationships between some of the system-level metrics we calculated
```{r}
system_metrics_comb%>%
  filter(hhi > 10000)

as_data_frame(network, what = "edges")%>%
  filter(to %in% c("CA1910200", "CA1910127", "CA5601117"))


ggpairs(system_metrics_comb[c(2:3, 5:6, 12)])+
  labs(title = "Scatterplot Matrix") +
  theme_bw()
```

# Worst-performing systems

Let's pull the worst-performing systems across various metrics
```{r}
#Systems with least source diversity
system_metrics_comb%>%
  arrange(-hhi)%>%
  head(10)

#Systems with longest average path length
system_metrics_comb%>%
  arrange(-mean_path_length)%>%
  head(10)

# Systems with just 1 source
system_metrics_comb%>%
  filter(in_degree == 1)
```

# Validation with Drought Vulnerability Data

Plots comparing distributions of vulnerability metrics by DWR drought vulnerability assessment
```{r}
system_metrics_comb%>%
  filter(!is.na(drought_vulnerable))%>%
  ggplot(aes(as.factor(drought_vulnerable), hhi))+
  geom_violin(fill = "coral1")+
  theme_bw()+
  labs(x = "DWR Drought Vulnerability", y = "HHI")
system_metrics_comb%>%
  filter(!is.na(drought_vulnerable))%>%
  ggplot(aes(as.factor(drought_vulnerable), in_degree))+
  geom_violin(fill = "coral1")+
  theme_bw()+
  labs(x = "DWR Drought Vulnerability", y = "In-Degree Centrality")
system_metrics_comb%>%
  filter(!is.na(drought_vulnerable))%>%
  ggplot(aes(as.factor(drought_vulnerable), mean_path_length))+
  geom_violin(fill = "coral1")+
  theme_bw()+
  labs(x = "DWR Drought Vulnerability", y = "Mean Path Length to Source")
```

Quick statistical test to see if distribution is different by group
Using mann-whitney test since data is non-parametric
```{r}
summary_stats = system_metrics_comb%>%
  filter(!is.na(drought_vulnerable))%>%
  group_by(drought_vulnerable)%>%
  reframe(in_degree = mean(in_degree),
          mean_path_length = mean(mean_path_length),
          hhi = mean(hhi))%>%
  mutate(drought_vulnerable = ifelse(drought_vulnerable == 0, "no_drought_vulnerability_mean", "drought_vulnerability_mean"))
summary_stats = summary_stats%>%
  t()%>%
  data.frame()%>%
  setNames(summary_stats[[1]]) %>% 
  slice(-1)%>%
  rownames_to_column("metric")

mann_whitney_results <- system_metrics_comb %>%
  summarise(
    in_degree_test = list(wilcox.test(in_degree ~ drought_vulnerable)),
    hhi_test = list(wilcox.test(hhi ~ drought_vulnerable)),
    mean_path_length_test = list(wilcox.test(mean_path_length ~ drought_vulnerable)))

tibble(
  metric = c("in_degree", "hhi", "mean_path_length"),
  test_statistic = c(
    mann_whitney_results$in_degree_test[[1]]$statistic,
    mann_whitney_results$hhi_test[[1]]$statistic,
    mann_whitney_results$mean_path_length_test[[1]]$statistic),
  p_value = c(
    mann_whitney_results$in_degree_test[[1]]$p.value,
    mann_whitney_results$hhi_test[[1]]$p.value,
    mann_whitney_results$mean_path_length_test[[1]]$p.value)) %>%
  mutate(
    significance = case_when(
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      TRUE ~ "ns"),
    p_value_formatted = format.pval(p_value, digits = 3))%>%
  select(-p_value)%>%
  left_join(., summary_stats, by = "metric")

rm(mann_whitney_results, summary_stats)
```
Tests indicate that small systems designated as drought-vulnerable tend to have greater in-degree (ie: more sources) and shorter path length (ie: less removed from their original sources) than non-drought-vulnerable systems. HHI is not significant. 






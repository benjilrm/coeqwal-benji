
# Set up

Import packages
```{r}
suppressPackageStartupMessages({
  suppressWarnings({
  library(tidyverse)   # Data wrangling
  library(here)        # File management
  library(readxl)      # Read excel files
  })})
```

Set settings and universal variables
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here())
```

# Import and clean data

Network data
```{r}
network = read.csv("Data/Outputs/20251017_network_data_projects_looped.csv")%>%
  select(-source_id)
```


Cleaning up source ID errors from manual review
```{r}
network = network%>%
  mutate(Source = case_when(
    PWSID == "CA0110001" & grepl("South Bay Aqueduct", Source_summary) ~ "South Bay Aqueduct",
    PWSID == "CA0110001" & grepl("Del Valle", Source_summary) ~ "Del Valle Reservoir",
    T ~ Source))
```


# Create source ID column
Use PWSID as source ID if source type is a PWS, otherwise generating a numerical source ID for each source (grouping by source name since there can be multiple rows with the same source)
```{r}
source_ids = network%>%
  group_by(Source) %>%
  mutate(group_id = paste("source", cur_group_id(), sep = "_")) %>%
  ungroup() %>%
  mutate(source_id = ifelse(Source_type == "PWS", Source, group_id)) %>%
  select(Source, source_id)%>%
  unique()
```


# Join source IDs
```{r}
network_joined = network%>%
  left_join(., source_ids, by = "Source")
```

Check to make sure it worked properly
```{r}
n_distinct(network$Source)
n_distinct(network_joined$source_id)
n_distinct(source_ids$source_id)

network_joined%>%
  group_by(Source)%>%
  filter(n_distinct(source_id) > 1)%>%
  arrange(Source)
```
# Export
```{r}
write.csv(network_joined, "Data/Outputs/20251017_network_w_source_ids.csv", row.names = F)
```






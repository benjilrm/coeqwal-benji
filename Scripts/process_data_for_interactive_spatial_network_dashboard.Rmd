
# Load packages
```{r}
suppressPackageStartupMessages({
  suppressWarnings({
    library(shiny)
    library(leaflet)
    library(leaflet.extras)
    library(leaflet.extras2)
    library(sf)
    library(dplyr)
    library(DT)
    })})
```

# Create fake datasets

## Nodes
### PW Systems
```{r}
enhanced_systems <- data.frame(
  system_id = paste0("sys_", 1:10),
  system_name = c("San Francisco PWS", "Los Angeles PWS", "San Diego PWS", 
                  "Sacramento PWS", "Fresno PWS", "Oakland PWS",
                  "San Jose PWS", "Long Beach PWS", "Bakersfield PWS", "Santa Cruz PWS"),
  pwsid = c("CA1234567", "CA2345678", "CA3456789", "CA4567890", "CA5678901",
            "CA6789012", "CA7890123", "CA8901234", "CA9012345", "CA0123456"),
  county = factor(c("San Francisco", "Los Angeles", "San Diego", "Sacramento", "Fresno",
                    "Alameda", "Santa Clara", "Los Angeles", "Kern", "Santa Cruz")),
  population = round(runif(10, 5000, 500000)),
  provider_type = factor(sample(c("Retail", "Retail & Wholesale", "Wholesale"), 10, replace = TRUE),
                         levels = c("Retail", "Retail & Wholesale", "Wholesale")),
  is_wholesale = factor(sample(c("Y", "N"), 10, replace = TRUE, prob = c(0.3, 0.7))),
  total_sources = sample(1:5, 10, replace = TRUE),
  total_sw_sources = sample(0:3, 10, replace = TRUE),
  has_gw_supply = factor(sample(c("Y", "N"), 10, replace = TRUE, prob = c(0.8, 0.2))),
  gw_mcl_compliant = factor(sample(c("Y", "N", "Unknown"), 10, replace = TRUE, 
                                   prob = c(0.6, 0.2, 0.2))),
  lat = runif(10, 34.0, 39.5),
  lon = runif(10, -122.5, -117.0))
```

### Sources
```{r}
enhanced_sources <- data.frame(
  source_id = c("src_A", "src_B", "src_C", "src_D", "src_E", "src_F", "src_G"),
  source_name = c("Hetch Hetchy Reservoir", "Owens River", "Colorado River Aqueduct", 
                  "Sacramento River", "Feather River", "Local Groundwater", "Delta Intake"),
  source_type = factor(c("Reservoir", "River", "Aqueduct", "River", "River", 
                         "Groundwater", "River Intake"),
                       levels = c("Reservoir", "River", "Aqueduct", "Groundwater", "River Intake", "Purchased")),
  source_lat = c(37.9468, 36.5436, 33.7175, 38.5976, 39.6543, 37.2345, 38.0456),
  source_lon = c(-119.7866, -118.2732, -114.7222, -121.1927, -121.3456, -121.1234, -121.7890),
  project = factor(c("SWP", "LADWP", "MWD", "CVP", "CVP", "Local", "SWP"),
                   levels = c("SWP", "CVP", "LADWP", "MWD", "Local")),
  capacity_mgd = runif(7, 100, 500))
```

## Links
```{r}
enhanced_connections <- do.call(rbind, lapply(enhanced_systems$system_id, function(sys_id) {
  num_connections <- sample(1:3, 1)
  data.frame(
    from = sample(enhanced_sources$source_id, num_connections, replace = TRUE),
    to = sys_id,
    purchase = sample(c(TRUE, FALSE), num_connections, replace = TRUE, prob = c(0.4, 0.6)),
    volume_mgd = round(runif(num_connections, 10, 200)),
    pct_supply_2022 = sample(c(NA, runif(5, 10, 100)), num_connections, replace = TRUE),
    pct_supply_2023 = sample(c(NA, runif(5, 10, 100)), num_connections, replace = TRUE),
    avg_pct_supply = runif(num_connections, 20, 100),
    avg_calc_method = factor(sample(c("Calculated", "Imputed"), num_connections, replace = TRUE, 
                                    prob = c(0.6, 0.4))))}))
```

Now we need to convert these links into spatial data (lines)
```{r}
create_connection_lines <- function(connections_df, sources_df, systems_df) {
  lines_list <- list()
  
  for (i in 1:nrow(connections_df)) {
    source_coords <- sources_df[sources_df$source_id == connections_df$from[i], c("source_lon", "source_lat")]
    system_coords <- systems_df[systems_df$system_id == connections_df$to[i], c("lon", "lat")]
    
    if (nrow(source_coords) > 0 && nrow(system_coords) > 0) {
      line <- st_linestring(rbind(
        as.numeric(c(source_coords$source_lon, source_coords$source_lat)),
        as.numeric(c(system_coords$lon, system_coords$lat))))
      lines_list[[i]] <- line}}
  
  valid_lines <- !sapply(lines_list, is.null)
  if (sum(valid_lines) > 0) {
    st_sf(
      connections_df[valid_lines, ],
      geometry = st_sfc(lines_list[valid_lines], crs = 4326)
    )} else {NULL}}
```

# Interactive dashboard

## UI
```{r}
# UI
ui <- fluidPage(
  titlePanel("California Water Systems Network Dashboard"),
  sidebarLayout(
    sidebarPanel(
      width = 3,
      
      # Search functionality
      h4("Search & Zoom"),
      selectizeInput("search_system", "Search System:",
                     choices = c("", enhanced_systems$system_name),
                     selected = "", multiple = FALSE,
                     options = list(placeholder = 'Type system name...')),
      selectizeInput("search_source", "Search Source:",
                     choices = c("", enhanced_sources$source_name),
                     selected = "", multiple = FALSE,
                     options = list(placeholder = 'Type source name...')),
      actionButton("zoom_selected", "Zoom to Selected", icon = icon("search")),
      actionButton("reset_view", "Reset View", icon = icon("globe")),
      hr(),
      
      # System Filters
      h4("System Filters"),
      selectInput("provider_type", "Provider Type:", 
                  choices = c("All", levels(enhanced_systems$provider_type))),
      selectInput("wholesale", "Wholesale:", choices = c("All", "Y", "N")),
      selectInput("gw_supply", "GW Supply:", choices = c("All", "Y", "N")),
      sliderInput("population", "Min Population:", 
                  min = 0, max = max(enhanced_systems$population), 
                  value = 0, step = 1000),
      hr(),
      
      # Source Filters
      h4("Source Filters"),
      selectInput("source_type", "Source Type:", 
                  choices = c("All", levels(enhanced_sources$source_type))),
      selectInput("project", "Project:", 
                  choices = c("All", levels(enhanced_sources$project))),
      hr(),
      
      # Connection Filters
      h4("Connection Filters"),
      selectInput("purchase_type", "Purchase Type:", 
                  choices = c("All", "Purchased", "Direct")),
      sliderInput("volume", "Min Volume (MGD):", 
                  min = 0, max = max(enhanced_connections$volume_mgd), 
                  value = 0, step = 10)),
    
    mainPanel(
      width = 9,
      leafletOutput("map", height = "600px"),
      tabsetPanel(
        tabPanel("Systems", DTOutput("systems_table")),
        tabPanel("Connections", DTOutput("connections_table")),
        tabPanel("Sources", DTOutput("sources_table"))))
  )
)
```

## Server
```{r}
server <- function(input, output, session) {
  
  selected_feature <- reactiveValues(system_id = NULL, source_id = NULL)
  
  # Add these observers for search functionality
  observeEvent(input$zoom_selected, {
    # Clear previous selections
    selected_feature$system_id <- NULL
    selected_feature$source_id <- NULL
    
    # Handle system search
    if (!is.null(input$search_system) && input$search_system != "") {
      system <- enhanced_systems %>% filter(system_name == input$search_system)
      if (nrow(system) > 0) {
        selected_feature$system_id <- system$system_id[1]
        
        # Zoom to the system
        leafletProxy("map") %>% 
          flyTo(lng = system$lon[1], lat = system$lat[1], zoom = 10)
      }
    }
    
    # Handle source search
    if (!is.null(input$search_source) && input$search_source != "") {
      source <- enhanced_sources %>% filter(source_name == input$search_source)
      if (nrow(source) > 0) {
        selected_feature$source_id <- source$source_id[1]
        
        # Zoom to the source
        leafletProxy("map") %>% 
          flyTo(lng = source$source_lon[1], lat = source$source_lat[1], zoom = 10)
      }
    }
  })
  
  observeEvent(input$reset_view, {
    # Clear selections and reset view
    selected_feature$system_id <- NULL
    selected_feature$source_id <- NULL
    updateSelectizeInput(session, "search_system", selected = "")
    updateSelectizeInput(session, "search_source", selected = "")
    
    leafletProxy("map") %>% 
      setView(lng = -119.4, lat = 37.2, zoom = 6)
  })
  
  # Also add these observers to update search inputs when clicking on map features
  observeEvent(input$map_marker_click, {
    click <- input$map_marker_click
    if (!is.null(click)) {
      # Check if it's a system marker
      systems_data <- filtered_data()$systems
      system_match <- systems_data %>%
        filter(lon == click$lng, lat == click$lat)
      
      if (nrow(system_match) > 0) {
        updateSelectizeInput(session, "search_system", selected = system_match$system_name[1])
        updateSelectizeInput(session, "search_source", selected = "")
      }
      
      # Check if it's a source marker
      sources_data <- filtered_data()$sources
      source_match <- sources_data %>%
        filter(source_lon == click$lng, source_lat == click$lat)
      
      if (nrow(source_match) > 0) {
        updateSelectizeInput(session, "search_source", selected = source_match$source_name[1])
        updateSelectizeInput(session, "search_system", selected = "")
      }
    }
  })
  
  filtered_data <- reactive({
    systems <- enhanced_systems
    sources <- enhanced_sources
    connections <- enhanced_connections
    
    # Apply basic filters
    if (input$provider_type != "All") systems <- systems %>% filter(provider_type == input$provider_type)
    if (input$wholesale != "All") systems <- systems %>% filter(is_wholesale == input$wholesale)
    if (input$gw_supply != "All") systems <- systems %>% filter(has_gw_supply == input$gw_supply)
    systems <- systems %>% filter(population >= input$population)
    
    if (input$source_type != "All") sources <- sources %>% filter(source_type == input$source_type)
    if (input$project != "All") sources <- sources %>% filter(project == input$project)
    
    if (input$purchase_type != "All") {
      purchase_flag <- input$purchase_type == "Purchased"
      connections <- connections %>% filter(purchase == purchase_flag)
    }
    connections <- connections %>% filter(volume_mgd >= input$volume)
    
    # Linked filtering
    systems <- systems %>% filter(system_id %in% connections$to)
    sources <- sources %>% filter(source_id %in% connections$from)
    connections <- connections %>% filter(to %in% systems$system_id & from %in% sources$source_id)
    
    # Search filtering (this part was missing the actual filtering logic)
    if (!is.null(selected_feature$system_id)) {
      systems <- systems %>% filter(system_id == selected_feature$system_id)
      connections <- connections %>% filter(to == selected_feature$system_id)
      sources <- sources %>% filter(source_id %in% connections$from)
    } else if (!is.null(selected_feature$source_id)) {
      sources <- sources %>% filter(source_id == selected_feature$source_id)
      connections <- connections %>% filter(from == selected_feature$source_id)
      systems <- systems %>% filter(system_id %in% connections$to)
    }
    
    list(systems = systems, sources = sources, connections = connections)
  })
  
  output$map <- renderLeaflet({
    leaflet() %>% addTiles() %>% setView(lng = -119.4, lat = 37.2, zoom = 6)
  })
  
  observe({
    data <- filtered_data()
    if (nrow(data$connections) > 0) {
      conn_lines <- create_connection_lines(data$connections, data$sources, data$systems)
      if (!is.null(conn_lines)) {
        leafletProxy("map") %>% clearMarkers() %>% clearShapes() %>%
          
          # Add sources
          addCircleMarkers(
            data = data$sources,
            lng = ~source_lon, lat = ~source_lat,
            radius = 8,
            color = "darkred",
            fillColor = "red",
            fillOpacity = 0.9,
            layerId = ~paste("source", source_id),
            popup = ~paste("<b>Source:</b>", source_name, "<br>",
                           "<b>Type:</b>", source_type, "<br>",
                           "<b>Project:</b>", project, "<br>",
                           "<b>Capacity:</b>", capacity_mgd, "MGD")
          ) %>%
          # Add systems
          addCircleMarkers(
            data = data$systems,
            lng = ~lon, lat = ~lat,
            radius = ~sqrt(population)/80,
            color = "darkblue",
            fillColor = "blue",
            fillOpacity = 0.7,
            layerId = ~paste("system", system_id),
            popup = ~paste("<b>System:</b>", system_name, "(", pwsid, ")<br>",
                           "<b>County:</b>", county, "<br>",
                           "<b>Population:</b>", format(population, big.mark = ","), "<br>",
                           "<b>Provider Type:</b>", provider_type)) %>%
          
          addArrowhead(data = conn_lines, color = "#0066CC", weight = 3, 
                       popup = ~paste("<b>From:</b>", from, "<br>",
                                      "<b>To:</b>", to, "<br>",
                                      "<b>Volume:</b>", volume_mgd, "MGD<br>",
                                      "<b>Purchase:</b>", ifelse(purchase, "Yes", "No"), "<br>",
                                      "<b>Avg % Supply:</b>", round(avg_pct_supply, 1), "%"))
      }
    } else {
      leafletProxy("map") %>% clearMarkers() %>% clearShapes()
    }
  })
  
  output$systems_table <- renderDT({ datatable(filtered_data()$systems) })
  output$connections_table <- renderDT({ datatable(filtered_data()$connections) })
  output$sources_table <- renderDT({ datatable(filtered_data()$sources) })
}
```

## Deploy
```{r}
shinyApp(ui, server)
```


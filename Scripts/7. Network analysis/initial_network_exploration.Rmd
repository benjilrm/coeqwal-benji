

# Set up

Import packages
```{r}
suppressPackageStartupMessages({
  suppressWarnings({
  library(tidyverse)   # Data wrangling
  library(here)        # File management
  library(igraph)      # Network analysis
  library(GGally)      # Exploratory scatter plots
  })})
```

Set settings and universal variables
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here())
```

# Import data

Our cleaned and processed network data generated into an igraph object
```{r}
load("Data/Outputs/20251112_network_igraph.Rdata")
```

# Analysis / Calculating Metrics

## Centrality

Calculate in, out, and total degree centrality for systems. Compile into one 'master' dataframe with system centralities 
```{r}
system_centrality = all_nodes%>%
  filter(type == "system")%>%
  rename(in_degree = num_sw_sources,
         out_degree = num_systems_served,
         pwsid = id)%>%
  mutate(
    out_degree = replace_na(out_degree, 0),
    total_degree = in_degree + out_degree)%>%
  arrange(-total_degree)%>%
  select(1,4,9,3,11,5:8)
```

Calculate betweenness centrality - systems that are major redistribution hubs (ie: measure of centrality based on shortest paths that pass through a given node). Add to master dataframe.
```{r}
betweenness_all = betweenness(network, directed = TRUE)
system_centrality$betweenness = betweenness_all[V(network)$type == "system"]
```


Out degree centrality for sources
```{r}
source_centrality = all_nodes%>%
  rename(source_name = id, out_degree = num_systems_served)%>%
  filter(type == "source")%>%
  arrange(-out_degree)%>%
  select(1:3)
```

## Path length

Calculate shortest paths from sources to systems
```{r}
sources = V(network)[type == "source"]
systems = V(network)[type == "system"]

# Get shortest paths from all sources to all systems
path_length_matrix = distances(network, v = sources, to = systems, mode = "out")
path_lengths = as.vector(path_length_matrix[is.finite(as.vector(path_length_matrix))])
```

Summary stats for sources' path lengths
```{r}
data.frame(
  source_name = sources$name,
  source_type = V(network)[sources]$source_type,
  mean_path_length = apply(path_length_matrix, 1, function(x) mean(x[is.finite(x)])),
  median_path_length = apply(path_length_matrix, 1, function(x) median(x[is.finite(x)])),
  max_path_length = apply(path_length_matrix, 1, function(x) max(x[is.finite(x)])),
  min_path_length = apply(path_length_matrix, 1, function(x) min(x[is.finite(x)])),
  n_reachable_systems = apply(path_length_matrix, 1, function(x) sum(is.finite(x))))%>%
  arrange(-mean_path_length)
```

Summary stats for systems' path lengths

Right now, this is ONLY when systems are the final node on a path
```{r}
system_path_lengths = data.frame(
  system_name = V(network)[systems]$system_name,
  pwsid = systems$name,
  pop_served = V(network)[systems]$pop_served,
  system_size = V(network)[systems]$system_size,
  mean_path_length = apply(path_length_matrix, 2, function(x) mean(x[is.finite(x)])),
  median_path_length = apply(path_length_matrix, 2, function(x) median(x[is.finite(x)])),
  max_path_length = apply(path_length_matrix, 2, function(x) max(x[is.finite(x)])),
  min_path_length = apply(path_length_matrix, 2, function(x) min(x[is.finite(x)])),
  n_reachable_sources = apply(path_length_matrix, 2, function(x) sum(is.finite(x))))%>%
  arrange(-max_path_length)
```

## Source diversity

```{r}
# Calculate HHI for each system
system_diversity = sapply(systems, function(system) {
  # Get edges going into this system (sources supplying it)
  incoming_edges = E(network)[.to(system)]
  
  if (length(incoming_edges) == 0) return(NA)  # no sources
  
  # Get the usage percentages for this system's sources
  usage_percentages = incoming_edges$average_source_usage/100
  
  # Calculate HHI (sum of squares of market shares, scaled 0-10000)
  hhi = sum((usage_percentages * 100)^2)
  
  return(hhi)})

# Create a diversity data frame
diversity_df = data.frame(
  system_name = V(network)[systems]$system_name,
  pwsid = systems$name,
  system_size = V(network)[systems]$system_size,
  pop_served = V(network)[systems]$pop_served,
  hhi = system_diversity,
  stringsAsFactors = FALSE,
  row.names = NULL)
```

Kristin also mentioned [participation coefficient](https://www.google.com/url?q=https://www.nature.com/articles/s41467-017-01189-w%23:~:text%3DParticipation%2520coefficient,-Given%2520a%2520particular%26text%3Dwhere%2520%257BK_i%257D%2520is%2520the%2520sum,are%2520to%2520a%2520single%2520community&sa=D&source=docs&ust=1762796373372331&usg=AOvVaw3DkgsUakhBdOK-fW7kOtPS). 

Seems like there are options to calculate it in R [example](https://search.r-project.org/CRAN/refmans/NetworkToolbox/html/participation.html)

## Local density / cluster / community
Kristin's hypothesis: on average, small systems will have less local density than large systems
How can we test?

## Bipartite project

Create one-mode projection on systems (systems connected if they share sources)
```{r}
system_adjacency = bipartite.projection(network)$proj2

# Degree in the projection = number of other systems sharing sources
system_shared_sources_degree = degree(system_adjacency)
system_degrees$shared_sources_degree = system_shared_sources_degree
```


# Visualisations / Tables

## Centrality

### Systems
System in-degree centrality
Possible metric for systems' source redunancy (# of sources)
```{r}
system_centrality%>%
  group_by(system_size)%>%
  reframe(in_degree = mean(in_degree, na.rm = T))%>%
  #filter(!is.na(system_size))%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = in_degree, fill = system_size))+
  geom_bar(stat = "identity")+
  theme_bw()+
  labs(x = "System Size", y = "Mean In-Degree Centrality")+
  theme(legend.position = "none")

system_centrality%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = in_degree, fill = system_size))+
  geom_boxplot()+
  theme_bw()+
  labs(x = "System Size", y = "In-Degree Centrality")+
  theme(legend.position = "none")
```

Out, total, betweenness centrality for systems
(more of a metric for measuring importance of redistribution hubs)
```{r}
ggplot(system_centrality, aes(total_degree))+
  geom_histogram(fill = "coral2", colour = "black")+
  theme_bw()

system_centrality%>%
  group_by(system_size)%>%
  reframe(total_degree = mean(total_degree, na.rm = T))%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = total_degree, fill = system_size))+
  geom_bar(stat = "identity")+
  theme_bw()+
  labs(x = "System Size", y = "Total Degree Centrality")+
  theme(legend.position = "none")+
  scale_y_log10()

system_centrality%>%
  group_by(system_size)%>%
  reframe(betweenness = mean(betweenness, na.rm = T))%>%
  #filter(!is.na(system_size))%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = betweenness, fill = system_size))+
  geom_bar(stat = "identity")+
  theme_bw()+
  labs(x = "System Size", y = "Mean Betweenness Centrality")+
  theme(legend.position = "none")

system_centrality%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = betweenness, fill = system_size))+
  geom_boxplot()+
  theme_bw()+
  labs(x = "System Size", y = "Betweenness Centrality")+
  theme(legend.position = "none")+
  scale_y_log10()
```

### Sources
```{r}
ggplot(source_centrality, aes(out_degree))+
  geom_histogram(fill = "coral2", colour = "black")+
  theme_bw()
```


## Source diversity
Systems' source diversity 
HHI index as possible metric for source diversity

```{r}
diversity_df%>%
  group_by(system_size)%>%
  reframe(hhi = mean(hhi, na.rm = T))%>%
  #filter(!is.na(system_size))%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = hhi, fill = system_size))+
  geom_bar(stat = "identity")+
  theme_bw()+
  labs(x = "System Size", y = "Mean HHI")+
  theme(legend.position = "none")

diversity_df%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = hhi, fill = system_size))+
  geom_boxplot()+
  theme_bw()+
  labs(x = "System Size", y = "HHI")+
  theme(legend.position = "none")
```

## Path length
Systems' path length to nearest source
Possible metric for source diversity
```{r}
system_path_lengths%>%
  group_by(system_size)%>%
  reframe(mean_path_length = mean(mean_path_length, na.rm = T))%>%
  #filter(!is.na(system_size))%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = mean_path_length, fill = system_size))+
  geom_bar(stat = "identity")+
  theme_bw()+
  labs(x = "System Size", y = "Mean Path Length")+
  theme(legend.position = "none")

system_path_lengths%>%
  mutate(system_size = factor(system_size, levels = c("Very Small", "Small", "Medium", "Large", "Very Large")))%>%
  ggplot(aes(x = system_size, y = mean_path_length, fill = system_size))+
  geom_boxplot()+
  theme_bw()+
  labs(x = "System Size", y = "Path Length")+
  theme(legend.position = "none")
```

# Summary stats

System centrality metrics
Filter for very small/small/medium systems
```{r}
system_centrality%>%
  filter(pop_served <= 10000)%>%
  select(in_degree:total_degree, betweenness)%>%
  summary()

system_centrality%>%filter(pop_served <= 10000)%>%
  select(in_degree:total_degree, betweenness)%>%
  pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
  ggplot(aes(value))+
  geom_histogram(binwidth = 1, fill = "steelblue", color = "black", alpha = 0.7) +
  facet_wrap(~variable, scales = "free")+
  labs(title = "System Centrality Metrics", x = "Value", y = "# of Systems") +
  theme_bw()
```
System path length
```{r}
system_path_lengths%>%
  filter(pop_served <= 10000)%>%
  select(mean_path_length:n_reachable_sources)%>%
  summary()

system_path_lengths%>%filter(pop_served <= 10000)%>%
  select(mean_path_length:n_reachable_sources)%>%
  pivot_longer(everything(), names_to = "variable", values_to = "value")%>%
  ggplot(aes(value))+
  geom_histogram(binwidth = 1, fill = "steelblue", color = "black", alpha = 0.7) +
  facet_wrap(~variable, scales = "free")+
  labs(title = "System Path Lengths Metrics", x = "Value", y = "# of Systems") +
  theme_bw()
```

System source diversity
```{r}
diversity_df%>%
  filter(pop_served <= 10000)%>%
  select(hhi)%>%
  summary()

diversity_df%>%filter(pop_served <= 10000)%>%
  ggplot(aes(hhi))+
  geom_histogram(fill = "steelblue", color = "black", alpha = 0.7) +
  labs(title = "System Source Diversity Metric", x = "Herfindahlâ€“Hirschman Index", y = "# of Systems") +
  theme_bw()
```

# Relationship between metrics

Let's make some quick scatter plots just to see the relationships between some of the system-level metrics we calculated
```{r}
master_systems = system_centrality%>%
  select(pwsid, in_degree:total_degree, betweenness)%>%
  left_join(., diversity_df%>%select(pwsid, hhi), by = "pwsid")%>%
  left_join(., system_path_lengths%>%select(pwsid, mean_path_length:n_reachable_sources), by = "pwsid")

ggpairs(master_systems[2:7])+
  labs(title = "Scatterplot Matrix") +
  theme_bw()
```

# Worst-performing systems

Let's pull the worst-performing systems across various metrics
```{r}
#Systems with least source diversity
diversity_df%>%
  arrange(-hhi)%>%
  head(10)

#Systems with longest average path length
system_path_lengths%>%
  arrange(-mean_path_length)%>%
  head(10)

# Systems with just 1 source
system_centrality%>%
  filter(in_degree == 1)
```




